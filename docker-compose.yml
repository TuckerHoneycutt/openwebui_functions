version: '3.8'

services:
  open-webui:
    build:
      context: .
      dockerfile: Dockerfile
      # Use --no-cache to ensure fresh build
      # args:
      #   BUILDKIT_INLINE_CACHE: "1"
    container_name: open-webui-template-formatter
    ports:
      - "3000:8080"
    volumes:
      # Persist OpenWebUI data
      - open-webui-data:/app/backend/data
      # Persist templates across container restarts
      - ./templates:/app/templates
      # Temp directory for generated PDFs
      - ./temp:/app/temp
      # Mount custom functions for easier updates (optional)
      - ./custom-functions:/app/custom-functions
    environment:
      # Template storage directory (persisted via volume)
      - TEMPLATE_STORAGE_DIR=/app/templates
      # PDF temp directory
      - PDF_TEMP_DIR=/app/temp
      # Add other OpenWebUI environment variables as needed
      # - OLLAMA_BASE_URL=http://host.docker.internal:11434
    # Run initialization script before OpenWebUI starts
    # This ensures functions are installed on every container start/restart
    # The script runs and then OpenWebUI starts normally
    # We try to preserve OpenWebUI's original entrypoint, falling back if needed
    entrypoint:
      - /bin/bash
      - -c
      - |
        /app/init-template-functions.sh
        # Try to find and execute OpenWebUI's original entrypoint
        if [ -f /entrypoint.sh ]; then
          exec /entrypoint.sh "$$@"
        elif [ -f /app/entrypoint.sh ]; then
          exec /app/entrypoint.sh "$$@"
        else
          # Fallback: start OpenWebUI directly
          exec python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8080 "$$@"
        fi
    restart: unless-stopped

volumes:
  open-webui-data:
